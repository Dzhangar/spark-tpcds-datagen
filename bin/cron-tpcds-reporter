#!/usr/bin/env bash

#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#    http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

#
# Shell script for running TPCDS benchmarks and push the results into github

# Determine the current working directory
_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

if [ -z "${SPARK_HOME}" ]; then
  echo "env SPARK_HOME not defined"
  exit 1
fi

# First, fetch the newest Spark code from the repository
rm -rf "${SPARK_HOME}" && git clone https://github.com/apache/spark ${SPARK_HOME}

# Generate test data in temp dir
_GENDATA_TEMP_DIR=`mktemp -d`
${_DIR}/../bin/dsdgen                    \
  --conf spark.sql.dsdgen.scaleFactor=1  \
  --conf spark.sql.dsdgen.format=parquet \
  --conf spark.sql.dsdgen.overwrite=true \
  ${_GENDATA_TEMP_DIR}

# Output performance results into a temporary file
_RESULTS_TEMP_FILE=`mktemp`
${_DIR}/../bin/run-tpcds-benchmark ${_GENDATA_TEMP_DIR} > ${_RESULTS_TEMP_FILE}

# Format the output results and append it into the report file
${_DIR}/../bin/format-results ${_RESULTS_TEMP_FILE} >> ${_DIR}/../reports/tpcds-avg-results.csv

# Push updated into git repository
DATE=`LANG=en_US.UTF-8 date '+%Y/%m/%d %H:%M'`
git add ${_DIR}/../reports/tpcds-avg-results.csv &&                                      \
  git commit -m "[AUTOMATICALLY GENERATED] Update TPCDS benchmark results in ${DATE}" && \
  git push origin master

